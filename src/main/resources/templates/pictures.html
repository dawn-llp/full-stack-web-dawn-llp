<!DOCTYPE html>
<html>
    <head>
        <title>User Home</title>
       <!-- <script type="text/javascript" src="jquery-1.11.1.min.js"></script> -->
    </head>
    <body>
        <h1 data-th-inline="text">[[${#httpServletRequest.remoteUser}]]'s palette!</h1>

        <div>
            <table style="border: 1px solid black">
                <tr>
                    <th>ID</th>
                    <th>URL</th>
                    <th>Dominant Colors</th>
                    <th>Similar Pallete</th>
                    <th>Palette Author</th>
                    <th>Palette</th>
                    <th>Palette Source</th>
                    <th>Rating</th>
                </tr>                
                <tr data-th-each="picture : ${pictures}">
                  <td data-th-text="${picture.id}"></td>
                    <td data-th-text="${picture.imgURL}"></td>
                     <td data-th-text="${picture.imgColors}"></td>
                    <td data-th-text="${picture.paletteTitle}"></td>
                    <td data-th-text="${picture.author}"></td>
                    <td data-th-text="${picture.paletteColors}"></td>
                    <td data-th-text="${picture.paletteSource}"></td>
                    <td data-th-text="${picture.rating}"></td>
                </tr>
            </table>
        </div>
        
        <hr />
        Test New Picture         
            <br />
        <form data-th-action="@{/pictures/add}" name="addPicForm" method="post">
        imgURL: <input type="text" name="imgURL" /><br />
        imgColors: <input type="text" name="imgColors" /><br />
        PaletteTitle: <input type="text" name="paletteTitle" /><br />
        PaletteAuthor: <input type="text" name="author" /><br />
        PaletteColors: <input type ="text" name="paletteColors" /><br />
        PaletteURL: <input type="text" name="paletteSource" /><br /> 
        rating: <input type="text" name="rating" /><br />
        
            <input type="submit" value="SUMBIT" />
        </form> 
        <hr />   
        <div>
       <!-- <form action="goPic.php" method="post"
enctype="multipart/form-data">-->
    <input type="file" id="filechooser" name="pic"  accept="image/*" />
    <input type = "submit" value="pic upload" />
   <!-- </form> -->
    <img alt="Image Previewer" id="previewer" />
</div>
<script>
document.write("hello");
var filechooser = document.getElementById('filechooser');
    var previewer = document.getElementById('previewer');

    // 200 KB 对应的字节数
    var maxsize = 200 * 1024;

    filechooser.onchange = function() {
        var files = this.files;
        var file = files[0];

        // 接受 jpeg, jpg, png 类型的图片
        if (!/\/(?:jpeg|jpg|png)/i.test(file.type)) return;

        var reader = new FileReader();

        reader.onload = function() {
            var result = this.result;
            var img = new Image();

            img.onload = function() {
                var compressedDataUrl = compress(img, file.type);
                toPreviewer(compressedDataUrl);

                img = null;
            };

            img.src = result;
        };

        reader.readAsDataURL(file);
        reader.readAsBinaryString(file);
        
    };

    function toPreviewer(dataUrl) {
        previewer.src = dataUrl;

        filechooser.value = '';
    }

    function compress(img, fileType) {
        var canvas = document.createElement("canvas");
        var ctx = canvas.getContext('2d');

        var width = img.width;
        var height = img.height;

        canvas.width = width;
        canvas.height = height;

        ctx.fillStyle = "#fff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.drawImage(img, 0, 0, width, height);

        // 压缩
        var base64data = canvas.toDataURL(fileType, 0.75);

        var initSize = img.src.length;
        console.log('压缩前：', initSize);
        console.log('压缩后：', base64data.length);
        console.log('压缩率：', 100 * (initSize - base64data.length) / initSize, "%");

        canvas = ctx = null;

        return base64data;
    }
</script>
    <hr />
        <form data-th-action="@{/logout}" method="post">
            <input type="submit" value="Sign Out"/>
        </form>
</body>
</html>